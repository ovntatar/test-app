{% extends "base.html" %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-12 col-md-10 col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h1 class="h4 mb-0">{{ _('Edit Billing Details') }}</h1>
          <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-sm btn-outline-secondary">
            {{ _('Back to User') }}
          </a>
        </div>

        <!-- User Info Banner -->
        <div class="alert alert-info mb-4">
          <div class="row align-items-center">
            <div class="col-md-6">
              <strong>{{ _('User') }}:</strong> {{ user.email }}
            </div>
            <div class="col-md-3">
              <strong>{{ _('Role') }}:</strong> 
              {% if user.role == 'admin' %}
                <span class="badge bg-danger">{{ _('Admin') }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ _('User') }}</span>
              {% endif %}
            </div>
            <div class="col-md-3">
              <strong>{{ _('Status') }}:</strong> 
              {% if user.is_active %}
                <span class="badge bg-success">{{ _('Active') }}</span>
              {% else %}
                <span class="badge bg-danger">{{ _('Disabled') }}</span>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Current Billing Info (if exists) -->
        {% if billing and billing.full_name %}
        <div class="alert alert-secondary mb-4">
          <h6 class="mb-2">{{ _('Current Billing Information') }}:</h6>
          <div class="small">
            {% if billing.full_name %}<strong>{{ billing.full_name }}</strong>{% endif %}
            {% if billing.company %} — {{ billing.company }}{% endif %}<br>
            {% if billing.address1 %}{{ billing.address1 }}{% endif %}
            {% if billing.address2 %} {{ billing.address2 }}{% endif %}<br>
            {% if billing.postal_code %}{{ billing.postal_code }}{% endif %}
            {% if billing.city %} {{ billing.city }}{% endif %}
            {% if billing.state %}, {{ billing.state }}{% endif %}<br>
            {% if billing.country %}{{ billing.country }}{% endif %}
            {% if billing.tax_id %} • {{ _('Tax/VAT') }}: {{ billing.tax_id }}{% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Billing Form -->
        <form method="POST" novalidate>
          {{ form.csrf_token }}
          
          <h5 class="mb-3">{{ _('Billing Contact') }}</h5>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              {{ form.full_name.label(class="form-label") }}
              {{ form.full_name(class="form-control" + (" is-invalid" if form.full_name.errors else "")) }}
              {% for error in form.full_name.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-6">
              {{ form.company.label(class="form-label") }}
              {{ form.company(class="form-control" + (" is-invalid" if form.company.errors else "")) }}
              {% for error in form.company.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
          </div>

          <h5 class="mb-3 mt-4">{{ _('Address') }}</h5>
          <div class="row g-3 mb-3">
            <div class="col-12">
              {{ form.address1.label(class="form-label") }}
              {{ form.address1(class="form-control" + (" is-invalid" if form.address1.errors else "")) }}
              {% for error in form.address1.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-12">
              {{ form.address2.label(class="form-label") }}
              {{ form.address2(class="form-control" + (" is-invalid" if form.address2.errors else "")) }}
              {% for error in form.address2.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              {{ form.postal_code.label(class="form-label") }}
              {{ form.postal_code(class="form-control" + (" is-invalid" if form.postal_code.errors else ""), placeholder="90210") }}
              {% for error in form.postal_code.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              {{ form.city.label(class="form-label") }}
              {{ form.city(class="form-control" + (" is-invalid" if form.city.errors else "")) }}
              {% for error in form.city.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
            <div class="col-md-4">
              {{ form.state.label(class="form-label") }}
              {{ form.state(class="form-control" + (" is-invalid" if form.state.errors else ""), placeholder="CA") }}
              {% for error in form.state.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
            </div>
          </div>

          <h5 class="mb-3 mt-4">{{ _('Tax Information') }}</h5>
          <div class="row g-3 mb-4">
            <div class="col-md-4">
              {{ form.country.label(class="form-label") }}
              {{ form.country(class="form-control" + (" is-invalid" if form.country.errors else ""), placeholder="DE") }}
              {% for error in form.country.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
              <small class="form-text text-muted">{{ _('ISO 2-letter code (e.g., DE, US, FR)') }}</small>
            </div>
            <div class="col-md-8">
              {{ form.tax_id.label(class="form-label") }}
              {{ form.tax_id(class="form-control" + (" is-invalid" if form.tax_id.errors else ""), placeholder="DE123456789") }}
              {% for error in form.tax_id.errors %}
                <div class="invalid-feedback">{{ error }}</div>
              {% endfor %}
              <small class="form-text text-muted">{{ _('VAT ID or Tax Number') }}</small>
            </div>
          </div>

          <hr>

          <div class="d-grid gap-2">
            {{ form.submit(class="btn btn-primary btn-lg") }}
            <a href="{{ url_for('admin.edit_user', user_id=user.id) }}" class="btn btn-outline-secondary">
              {{ _('Cancel') }}
            </a>
          </div>
        </form>

        <!-- Quick Actions -->
        <div class="mt-4 d-flex justify-content-between">
          <a href="{{ url_for('admin.index') }}" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> {{ _('Back to User List') }}
          </a>
          {% if billing and billing.id %}
          <form method="POST" action="{{ url_for('admin.clear_user_billing', user_id=user.id) }}" style="display: inline;">
            <button type="submit" class="btn btn-sm btn-outline-danger" 
                    onclick="return confirm('{{ _('Clear all billing information for this user?') }}')">
              <i class="bi bi-trash"></i> {{ _('Clear Billing Data') }}
            </button>
          </form>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}
