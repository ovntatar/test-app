{% extends "base.html" %}

{% block content %}
<div class="mb-4">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h1 class="h3">{{ _('API Keys') }}</h1>
      <p class="text-muted">{{ _('Manage your API keys for programmatic access') }}</p>
    </div>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createKeyModal">
      <i class="bi bi-plus-circle"></i> {{ _('Create API Key') }}
    </button>
  </div>
</div>

<!-- API Key Limit Info -->
<div class="alert alert-info mb-4">
  <div class="d-flex align-items-center">
    <i class="bi bi-info-circle me-2" style="font-size: 1.5rem;"></i>
    <div>
      <strong>{{ _('Your Plan') }}: {{ current_user.plan_name }}</strong><br>
      <small>
        {{ _('Active Keys') }}: {{ current_user.active_api_keys_count }} / 
        {% if current_user.plan_name == 'Free' %}1
        {% elif current_user.plan_name == 'Pro' %}5
        {% else %}{{ _('Unlimited') }}
        {% endif %}
      </small>
    </div>
  </div>
</div>

<!-- API Keys List -->
{% if keys %}
<div class="card">
  <div class="card-body">
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>{{ _('Name') }}</th>
            <th>{{ _('Key') }}</th>
            <th>{{ _('Status') }}</th>
            <th>{{ _('Created') }}</th>
            <th>{{ _('Last Used') }}</th>
            <th>{{ _('Actions') }}</th>
          </tr>
        </thead>
        <tbody>
          {% for key in keys %}
          <tr class="{% if not key.is_active %}table-secondary{% endif %}">
            <td>
              <strong>{{ key.name }}</strong>
            </td>
            <td>
              <code class="text-muted">{{ key.masked_key }}</code>
            </td>
            <td>
              {% if key.is_active %}
                <span class="badge bg-success">{{ _('Active') }}</span>
              {% else %}
                <span class="badge bg-secondary">{{ _('Disabled') }}</span>
              {% endif %}
            </td>
            <td>
              <small>{{ key.created_at.strftime('%Y-%m-%d') }}</small>
            </td>
            <td>
              {% if key.last_used_at %}
                <small>{{ key.last_used_at.strftime('%Y-%m-%d %H:%M') }}</small>
              {% else %}
                <span class="text-muted">{{ _('Never') }}</span>
              {% endif %}
            </td>
            <td>
              <div class="btn-group btn-group-sm" role="group">
                <!-- Toggle Button -->
                <form method="POST" action="{{ url_for('account.toggle_api_key', key_id=key.id) }}" style="display: inline;">
                  <button type="submit" class="btn btn-outline-{% if key.is_active %}warning{% else %}success{% endif %}" 
                          title="{% if key.is_active %}{{ _('Disable') }}{% else %}{{ _('Enable') }}{% endif %}">
                    <i class="bi bi-{% if key.is_active %}pause-circle{% else %}play-circle{% endif %}"></i>
                  </button>
                </form>
                
                <!-- Regenerate Button -->
                <form method="POST" action="{{ url_for('account.regenerate_api_key', key_id=key.id) }}" style="display: inline;">
                  <button type="submit" class="btn btn-outline-primary" 
                          title="{{ _('Regenerate') }}"
                          onclick="return confirm('{{ _('This will invalidate the old key. Continue?') }}')">
                    <i class="bi bi-arrow-clockwise"></i>
                  </button>
                </form>
                
                <!-- Delete Button -->
                <form method="POST" action="{{ url_for('account.delete_api_key', key_id=key.id) }}" style="display: inline;">
                  <button type="submit" class="btn btn-outline-danger" 
                          title="{{ _('Delete') }}"
                          onclick="return confirm('{{ _('Delete this API key permanently?') }}')">
                    <i class="bi bi-trash"></i>
                  </button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="card">
  <div class="card-body text-center py-5">
    <i class="bi bi-key" style="font-size: 4rem; color: #ccc;"></i>
    <h4 class="mt-3">{{ _('No API Keys Yet') }}</h4>
    <p class="text-muted">{{ _('Create your first API key to access the API programmatically') }}</p>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createKeyModal">
      {{ _('Create Your First API Key') }}
    </button>
  </div>
</div>
{% endif %}

<!-- API Documentation -->
<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title">{{ _('Quick Start Guide') }}</h5>
    
    <h6 class="mt-3">{{ _('Authentication') }}</h6>
    <p>{{ _('Include your API key in the Authorization header') }}:</p>
    <pre class="bg-light p-3 rounded"><code>curl -H "Authorization: Bearer YOUR_API_KEY" \
  {{ request.url_root }}api/v1/me</code></pre>
    
    <h6 class="mt-3">{{ _('Available Endpoints') }}</h6>
    <ul>
      <li><code>GET /api/v1/ping</code> - {{ _('Public health check (no auth)') }}</li>
      <li><code>GET /api/v1/me</code> - {{ _('Get current user info') }}</li>
      <li><code>GET /api/v1/profile</code> - {{ _('Get full profile') }}</li>
      <li><code>GET /api/v1/api-keys</code> - {{ _('List your API keys') }}</li>
      <li><code>GET /api/v1/stats</code> - {{ _('Get usage statistics') }}</li>
    </ul>
    
    <div class="alert alert-warning mt-3">
      <strong>{{ _('Security Tips') }}:</strong>
      <ul class="mb-0">
        <li>{{ _('Never share your API keys publicly') }}</li>
        <li>{{ _('Store keys securely (environment variables)') }}</li>
        <li>{{ _('Regenerate keys if compromised') }}</li>
        <li>{{ _('Disable unused keys') }}</li>
      </ul>
    </div>
  </div>
</div>

<!-- Create API Key Modal -->
<div class="modal fade" id="createKeyModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">{{ _('Create API Key') }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="POST" action="{{ url_for('account.create_api_key') }}">
        <div class="modal-body">
          <div class="mb-3">
            <label for="keyName" class="form-label">{{ _('Key Name') }} ({{ _('Optional') }})</label>
            <input type="text" class="form-control" id="keyName" name="name" 
                   placeholder="e.g., Production Server, Mobile App">
            <small class="form-text text-muted">{{ _('Help identify this key later') }}</small>
          </div>
          
          <div class="alert alert-info">
            <small>
              <strong>{{ _('Note') }}:</strong> 
              {{ _('The API key will be shown only once. Make sure to copy it immediately.') }}
            </small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{{ _('Cancel') }}</button>
          <button type="submit" class="btn btn-primary">{{ _('Create Key') }}</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Bootstrap Icons -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
{% endblock %}
